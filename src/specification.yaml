openapi: 3.1.1
info:
  title: CPM Registry API
  description: |
    API for the CPM Registry, used by the Chung Package Manager (cpm) to host
    and distribute ComputerCraft-focused Lua packages.
  version: 1.0.0
servers:
  - url: https://registry.cpm.chungindustries.com
    description: Production API
tags:
  - name: Packages
    description: Endpoints for browsing and retrieving cpm packages.
paths:
  /packages:
    get:
      tags: [Packages]
      summary: List packages
      description: Returns all cpm packages in the registry.
      operationId: listPackages
      responses:
        '200':
          description: Array of packages.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Package'
              examples:
                sample:
                  value:
                    - name: example
                      author: chungindustries
                      versions:
                        '1.0.0':
                          name: example
                          author: chungindustries
                          version: 1.0.0
                          dependencies:
                            cc-http: '^1.2.0'
                          dist:
                            tarball: https://registry.cpm.chungindustries.com/packages/example/1.0.0/dist/tarball
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      tags: [Packages]
      summary: Publish or update package
      description: |
        Upserts a cpm package in the registry. Creates the package if it does not exist, 
        or updates/merges versions if it does. Supply metadata plus the tarball in a
        single multipart request.
      operationId: upsertPackage
      requestBody:
        required: true
        description: Package metadata and tarball to upsert.
        content:
          multipart/form-data:
            schema:
              type: object
              required: [meta, tarball]
              properties:
                meta:
                  type: string
                  description: JSON-encoded `PackageVersionMetadata` for this version.
                  example: |
                    {"name":"example","author":"chungindustries","version":"1.0.0","dependencies":{"cc-http":"^1.2.0"}}
                tarball:
                  type: string
                  format: binary
                  description: Tarball file for the package version (e.g., example-1.0.0.tgz).
      responses:
        '200':
          description: Package updated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Package'
        '201':
          description: Package created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Package'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /packages/{name}:
    get:
      tags: [Packages]
      summary: Get package
      description: Returns the cpm package entry for the given package name.
      operationId: getPackage
      parameters:
        - $ref: '#/components/parameters/packageName'
      responses:
        '200':
          description: Package found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Package'
              examples:
                sample:
                  value:
                    name: example
                    author: chungindustries
                    versions:
                      '1.0.0':
                        name: example
                        author: chungindustries
                        version: 1.0.0
                        dependencies:
                          cc-http: '^1.2.0'
                        dist:
                          tarball: https://registry.cpm.chungindustries.com/packages/example/1.0.0/dist/tarball
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /packages/{name}/{version}:
    get:
      tags: [Packages]
      summary: Get package version
      description: Returns the cpm package entry for a specific version.
      operationId: getPackageVersion
      parameters:
        - $ref: '#/components/parameters/packageName'
        - $ref: '#/components/parameters/packageVersion'
      responses:
        '200':
          description: Package version found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PackageVersionEntry'
              examples:
                sample:
                  value:
                    name: example
                    author: chungindustries
                    version: 1.0.0
                    dependencies:
                      cc-http: '^1.2.0'
                    dist:
                      tarball: https://registry.cpm.chungindustries.com/packages/example/1.0.0/dist/tarball
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
components:
  parameters:
    packageName:
      name: name
      in: path
      required: true
      description: Package name.
      schema:
        type: string
        pattern: '^[a-z0-9._-]+$'
        examples:
          - example
    packageVersion:
      name: version
      in: path
      required: true
      description: Package version (semantic version).
      schema:
        type: string
        pattern: '^[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9.-]+)?$'
        examples:
          - 1.0.0
  responses:
    BadRequest:
      description: Bad request.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            badRequest:
              value:
                message: Invalid payload.
    NotFound:
      description: Resource not found.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            notFound:
              value:
                message: Package not found.
    InternalServerError:
      description: Internal server error.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            internalServerError:
              value:
                message: Unexpected error occurred.
  schemas:
    Package:
      type: object
      required: [name, versions]
      properties:
        name:
          type: string
          description: Package name.
          examples: [example]
        author:
          type: string
          description: Package author.
          examples: [chungindustries]
        versions:
          type: object
          description: Map of version -> version metadata.
          additionalProperties:
            $ref: '#/components/schemas/PackageVersion'
          example:
            '1.0.0':
              name: example
              author: chungindustries
              version: 1.0.0
              dependencies:
                cc-http: '^1.2.0'
              dist:
                tarball: https://registry.cpm.chungindustries.com/packages/example/1.0.0/dist/tarball
    PackageVersion:
      type: object
      required: [name, version, dist]
      properties:
        name:
          type: string
          description: Package name.
          examples: [example]
        author:
          type: string
          description: Package author.
          examples: [chungindustries]
        version:
          type: string
          description: Package version.
          examples: [1.0.0]
        dependencies:
          type: object
          description: Map of dependency -> semver range.
          additionalProperties:
            type: string
          example:
            cc-http: '^1.2.0'
        dist:
          $ref: '#/components/schemas/Dist'
    PackageVersionMetadata:
      type: object
      required: [name, version]
      properties:
        name:
          type: string
          description: Package name.
          examples: [example]
        author:
          type: string
          description: Package author.
          examples: [chungindustries]
        version:
          type: string
          description: Package version.
          examples: [1.0.0]
        dependencies:
          type: object
          description: Map of dependency -> semver range.
          additionalProperties:
            type: string
          example:
            cc-http: '^1.2.0'
    PackageVersionEntry:
      $ref: '#/components/schemas/PackageVersion'
    Dist:
      type: object
      required: [tarball]
      properties:
        tarball:
          type: string
          format: uri
          description: URL to the packaged tarball.
          examples:
            - https://registry.cpm.chungindustries.com/packages/example/1.0.0/dist/tarball
    Error:
      type: object
      required: [message]
      properties:
        message:
          type: string
          description: Human-readable message.
        errors:
          description: Optional validation or diagnostic details.
          type: array
          items:
            type: object
            additionalProperties: true
